\section{Implementation of NFC}
We have created a class called \lstinline|NfcForegroundActivity| which every activity that we want to enable \ac{nfc} on can extend. \lstinline|NfcForegroundActivity| contains some useful methods to aid in the use of the \ac{nfc} tags.

\subsection{Foreground Mode}
\label{sec:foeground}

It is possible to force priority over other activities when handling \ac{nfc} intents using the Foregroud Dispatch System \citep{foregroundDispatch}. This enables us to handle the intent when the user has our activity open and scans an \ac{nfc} tag.

\begin{lstlisting}[language=java, label=nfcForegroundOnCreate, caption=OnCreate]
public NfcForeground(Context context) { 
  this.nfcAdapter = NfcAdapter.getDefaultAdapter(this.context);
  this.nfcPendingIntent = PendingIntent.getActivity(this.context, 0, new Intent(this.context, ((Activity) this.context).getClass()).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP), 0);
}
\end{lstlisting}\todo{fix caption}
\begin{description}
\item[Line 2] The default \ac{nfc} adapter is get and saved.
\item[Line 3] A pending intent is created and saved for later use.
\end{description}\todo{Description skal m√•ske uddybes}
As seen in \autoref{nfcForegroundOnCreate} a pending intent is set. This is necessary because the system must have an intent to populate when an \ac{nfc} tag is scanned.

\begin{lstlisting}[language=java, caption=Foreground mode enabling]
protected void onResume() {
  // foreground mode gives the current active application priority for reading scanned tags
  IntentFilter tagDetected = new IntentFilter(NfcAdapter.ACTION_TAG_DISCOVERED); // filter for tags
  IntentFilter[] writeTagFilters = new IntentFilter[] { tagDetected };
  this.nfcAdapter.enableForegroundDispatch((Activity) this.context, this.nfcPendingIntent, writeTagFilters, null);
}
\end{lstlisting}
\begin{description}
\item[Line 3] An \lstinline|IntentFilter| is created. This particular filter tells the system that we want to override the behaviour when an \ac{nfc} tag is scanned.
\item[Line 4] The filter is added to an array. This is required because you can have multiple filters.
\item[Line 5] Foreground mode is enabled with the pending intent from \autoref{nfcForegroundOnCreate} and the intent filter.
\end{description}

\subsubsection{Handling of NFC Intent}
When an \ac{nfc} tag is scanned the method shown in \autoref{lst:onNewIntent} is called. This method is a part of \lstinline|NfcForegroundActivity|.
\begin{lstlisting}[language=java, label=lst:onNewIntent, caption=onNewIntent]
@Override
/* This method is called when an NFC tag is scanned */
public void onNewIntent(Intent intent) { 
    super.onNewIntent(intent);
    ArrayList<Record> records = this.nfcForeground.newIntentEvent(intent);
    if(records.size() > 0) {
        this.onNfcScanned(records);
    }
}  
\end{lstlisting}
\begin{description}
\item[Line 3] The intent that \lstinline|onNewIntent| in \autoref{lst:onNewIntent} takes is the pending intent that was created in \autoref{nfcForegroundOnCreate}.
\item[Line 5] The method \lstinline|newIntentEvent| of the class \lstinline|NfcForeground| is run with the intent and a list of records is returned.
\item[Lines 6-7] If any records were found \lstinline|onNfcScanned| is called with these.
\end{description}
As seen in \autoref{lst:onNewIntent} on line 5, the records are gathered trough the use of \lstinline|this.nfcForeground.newIntentEvent(intent);|\autoref{lst:newIntentEvent}.

\begin{lstlisting}[language=java, label=lst:newIntentEvent, caption=newIntentEvent]
public ArrayList<Record> newIntentEvent(Intent intent) {
  Parcelable[] messages = intent.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);
  ArrayList<Record> foundRecords = new ArrayList<Record>();

  if (messages != null) {
    Log.d(this.getClass().getSimpleName(), "Found " + messages.length + " NDEF messages");

    this.vibrate(); // signal found messages

    // parse to records
    for (int i = 0; i < messages.length; i++) {
      try {
        List<Record> records = new Message((NdefMessage)messages[i]);

        Log.d(this.getClass().getSimpleName(), "Found " + records.size() + " records in message " + i);

        for(int k = 0; k < records.size(); k++) {
          Log.d(this.getClass().getSimpleName(), " Record #" + k + " is of class " + records.get(k).getClass().getSimpleName());

          Record record = records.get(k);
          foundRecords.add(record);

        }
      } catch (Exception e) {
        Log.e(this.getClass().getSimpleName(), "Problem parsing message", e);
      }

    }
  }
  return foundRecords;
}
\end{lstlisting}





As seen in \autoref{lst:onNewIntent} on line 7, the method \lstinline|onNfcScanned| is called. This method is abstract and hence must be overwritten in the activity that extends \lstinline|NfcForegroundActivity|. This allows for a very easy way to handle the records that lie on the \ac{nfc} tag.

The \lstinline|NfcForegroundActivity| class contains an abstract method \lstinline|protected abstract void onNfcScanned(ArrayList<Record> records)|. 


NDEF Tools for Android \citep{ndeftools}